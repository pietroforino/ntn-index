---
const { icons = ["ğŸ”©", "ğŸ› ï¸", "ğŸ“", "ğŸ”—"], size = 64, z = 100 } = Astro.props;
---

<style>
  .icons-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: var(--z, 9999);
  }

  .floating-icon {
    position: absolute;
    width: var(--size, 64px);
    height: var(--size, 64px);
    display: grid;
    place-items: center;
    cursor: pointer;
    pointer-events: auto;
    opacity: 1;
    will-change: transform, opacity;
    font-size: 42px;
  }

  @media screen and (min-width: 480px) {
    .icons-layer {
      display: none;
    }
  }
</style>

<div
  class="icons-layer"
  id="icons-layer"
  style={`--size: ${size}px; --z: ${z};`}
>
  <div class="floating-icon" id="floating-icon">
    <span id="floating-icon-img">{icons[0]}</span>
  </div>
</div>

<script is:inline type="module">
  (function () {
    const icons = ["ğŸ”©", "ğŸ› ï¸", "ğŸ“", "ğŸ”—"];
    const layer = document.getElementById("icons-layer");
    const btn = document.getElementById("floating-icon");
    const img = document.getElementById("floating-icon-img");
    const size =
      parseInt(getComputedStyle(layer).getPropertyValue("--size")) || 64;

    let currentIndex = 0;

    function randInt(max) {
      return Math.floor(Math.random() * max);
    }

    function placeRandom() {
      const vw = Math.max(
        document.documentElement.clientWidth || 0,
        window.innerWidth || 0
      );
      const vh = Math.max(
        document.documentElement.clientHeight - 50 || 0,
        window.innerHeight - 50 || 0
      );

      const padding = 12;
      const maxLeft = Math.max(0, vw - size - padding);
      const maxTop = Math.max(0, vh - size - padding);

      const left = randInt(maxLeft) + padding;
      const top = randInt(maxTop) + 50 + padding;

      btn.style.left = left + "px";
      btn.style.top = top + "px";
    }

    function pickDifferentIndex() {
      if (icons.length <= 1) return 0;
      let next = currentIndex;
      while (next === currentIndex) {
        next = randInt(icons.length);
      }
      return next;
    }

    placeRandom();

    let resizeTimeout;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(placeRandom, 120);
    });

    let counter = 0;
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      btn.classList.add("hidden");
      counter++;
      if (counter > 4) {
        document.querySelector(".icons-layer").remove();
        return;
      }
      const next = pickDifferentIndex();
      currentIndex = next;
      img.innerHTML = icons[currentIndex];
      placeRandom();
      requestAnimationFrame(() => {
        btn.classList.remove("hidden");
      });
    });

    setTimeout(() => {
      btn.style.opacity = 1;
    }, 300);
  })();
</script>
